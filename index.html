<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Token Almas SFT</title>
  <!-- Bootstrap desde CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    #status { min-height: 60px; }
    #cornerImage { position: fixed; bottom: 20px; right: 20px; max-width: 150px; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-md-8 col-lg-6">
        <div class="card shadow">
          <div class="card-body text-center">
            <h1 class="card-title mb-4">Token Almas SFT</h1>
            <img src="imagenes/lorddev.jpg" class="img-fluid rounded mb-4" style="max-height: 200px;">
            
            <button id="connectButton" class="btn btn-primary btn-lg mb-3">
              üîå Conectar Wallet
            </button>
            <button id="claimButton" class="btn btn-success btn-lg mb-3" disabled>
              üéÅ Reclamar Token
            </button>
            
            <div id="status" class="alert alert-info"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ethers.js desde CDN alternativo -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  
  <!-- Nuestro JavaScript embebido para evitar errores 404 -->
  <script>
    // Debug inicial
    console.log("Iniciando aplicaci√≥n...");
    document.getElementById('status').textContent = "Cargando aplicaci√≥n...";

    // Configuraci√≥n
    const CONTRACT_ADDRESS = "0x20ae870f101b578917fec53d4e98ef0abe0df6fc";
    const ABI = [
      {
        "inputs": [
          {"internalType":"address","name":"account","type":"address"},
          {"internalType":"uint256","name":"id","type":"uint256"},
          {"internalType":"uint256","name":"amount","type":"uint256"},
          {"internalType":"bytes","name":"data","type":"bytes"}
        ],
        "name":"mint",
        "outputs":[],
        "stateMutability":"nonpayable",
        "type":"function"
      }
    ];

    // 1. Verificar MetaMask al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', () => {
      console.log("DOM completamente cargado");
      
      if (typeof window.ethereum === 'undefined') {
        showError("‚ùå MetaMask no detectado. Instala la extensi√≥n para continuar.");
        document.getElementById("connectButton").disabled = true;
        return;
      }
      
      console.log("MetaMask detectado:", window.ethereum);
      setupEventListeners();
    });

    // 2. Configurar listeners de eventos
    function setupEventListeners() {
      console.log("Configurando event listeners...");
      
      document.getElementById('connectButton').addEventListener('click', async () => {
        console.log("Bot√≥n Conectar clickeado");
        await handleWalletConnection();
      });
    }

    // 3. Manejar conexi√≥n de wallet
    async function handleWalletConnection() {
      const connectButton = document.getElementById('connectButton');
      const statusElement = document.getElementById('status');
      
      try {
        console.log("Iniciando conexi√≥n...");
        statusElement.textContent = "Conectando a MetaMask...";
        connectButton.disabled = true;
        
        // Solicitar conexi√≥n de cuentas
        const accounts = await window.ethereum.request({ 
          method: "eth_requestAccounts" 
        });
        
        console.log("Cuentas recibidas:", accounts);
        
        // Verificar red (Sepolia Testnet)
        const chainId = await window.ethereum.request({ method: 'eth_chainId' });
        console.log("ChainID actual:", chainId);
        
        if (chainId !== "0xaa36a7") {
          await switchToSepolia();
          return;
        }
        
        // Configurar ethers.js
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();
        const address = await signer.getAddress();
        
        console.log("Conexi√≥n exitosa. Direcci√≥n:", address);
        
        // Actualizar UI
        statusElement.innerHTML = `
          <span class="text-success">‚úÖ Conectado correctamente</span>
          <p class="small mb-0">${address.substring(0, 6)}...${address.substring(38)}</p>
        `;
        connectButton.textContent = "‚úÖ Conectado";
        connectButton.classList.remove('btn-primary');
        connectButton.classList.add('btn-success');
        
        // Habilitar funcionalidad adicional
        document.getElementById("claimButton").disabled = false;
        
      } catch (error) {
        console.error("Error en conexi√≥n:", error);
        showError(`Error de conexi√≥n: ${error.message}`);
        connectButton.disabled = false;
      }
    }

    // 4. Cambiar a Sepolia Testnet
    async function switchToSepolia() {
      const statusElement = document.getElementById('status');
      
      try {
        console.log("Intentando cambiar a Sepolia...");
        statusElement.textContent = "Cambiando a Sepolia Testnet...";
        
        await window.ethereum.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: "0xaa36a7" }] // Sepolia
        });
        
        console.log("Cambio a Sepolia exitoso");
        await handleWalletConnection();
        
      } catch (error) {
        console.error("Error cambiando de red:", error);
        
        if (error.code === 4902) {
          try {
            await window.ethereum.request({
              method: "wallet_addEthereumChain",
              params: [{
                chainId: "0xaa36a7",
                chainName: "Sepolia Test Network",
                nativeCurrency: {
                  name: "Sepolia ETH",
                  symbol: "ETH",
                  decimals: 18
                },
                rpcUrls: ["https://rpc.sepolia.org"],
                blockExplorerUrls: ["https://sepolia.etherscan.io"]
              }]
            });
            await switchToSepolia();
          } catch (addError) {
            console.error("Error a√±adiendo red Sepolia:", addError);
            showError("Por favor cambia manualmente a Sepolia Testnet en MetaMask");
          }
        }
      }
    }

    function showError(message) {
      const statusElement = document.getElementById('status');
      statusElement.innerHTML = `
        <span class="text-danger">‚ùå ${message}</span>
      `;
      statusElement.classList.remove('alert-info');
      statusElement.classList.add('alert-danger');
    }

    // Funci√≥n para mostrar mensaje de √©xito
    function showSuccess(message) {
      const statusElement = document.getElementById('status');
      statusElement.innerHTML = `
        <span class="text-success">‚úÖ ${message}</span>
      `;
      statusElement.classList.remove('alert-danger');
      statusElement.classList.add('alert-success');
    }
  </script>
</body>
</html>